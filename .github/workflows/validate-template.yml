# validate-template.yml - Validate template generation with different configurations
#
# This workflow ensures that templates generate working projects across
# all supported configuration combinations (auth providers, features).
#
# Runs on:
# - Push to main (when template-related files change)
# - Pull requests to main

name: Validate Template

on:
  push:
    branches: [main]
    paths:
      - 'copier.yaml'
      - '_tasks.py'
      - 'scripts/templatize.sh'
      - 'src/**'
      - 'package.json'
      - 'Dockerfile'
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            data_args: ""
          - name: auth-ory
            data_args: "--data auth_enabled=true --data auth_provider=ory"
          - name: no-mocks
            data_args: "--data use_mocks=false"

    name: Validate (${{ matrix.name }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python for Copier
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run templatize script
        run: |
          chmod +x ./scripts/templatize.sh
          ./scripts/templatize.sh .templatized

      - name: Install Copier
        run: pipx install copier

      - name: Generate project (${{ matrix.name }})
        run: |
          copier copy .templatized /tmp/test-project \
            --defaults --trust \
            --data project_name="Test Project" \
            ${{ matrix.data_args }}

      - name: Install dependencies
        run: cd /tmp/test-project && npm install

      - name: Lint (biome)
        run: cd /tmp/test-project && npm run lint

      - name: Type check (tsc)
        run: cd /tmp/test-project && npm run typecheck

      - name: Build
        run: cd /tmp/test-project && npm run build

      - name: Summary
        if: always()
        run: |
          echo "## Validation: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configuration: \`${{ matrix.data_args || 'defaults' }}\`" >> $GITHUB_STEP_SUMMARY
